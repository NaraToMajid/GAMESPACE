<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WORLD OF SPACE - Meteor Game</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700;800&display=swap" rel="stylesheet">
<style>
    :root{
        --bg:#000;
        --hp-bg:#222;
        --hp-fill-start:#2dd4ff;
        --hp-fill-end:#1e90ff;
        --ui-z:100;
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:'Orbitron',sans-serif;overflow:hidden}
    /* stars */
    .star{position:absolute;width:2px;height:2px;background:#fff;border-radius:50%;opacity:.8;animation:starMove linear infinite}
    @keyframes starMove{from{transform:translateY(0)}to{transform:translateY(140vh)}}

    /* meteor */
    .meteor{position:absolute;width:120px;pointer-events:none}

    /* player */
    #player{position:absolute;width:160px;display:none;left:-320px;top:50%;transform:translateY(-50%);transition:left 1.4s cubic-bezier(.22,.9,.2,1)}

    /* bullet */
    .peluru{position:absolute;width:14px;height:4px;border-radius:6px;box-shadow:0 0 14px rgba(255,255,255,.9);background:linear-gradient(90deg,#fff,#cde)}
    .peluru.upgraded{width:20px;height:6px;box-shadow:0 0 20px rgba(255,255,100,.9);background:linear-gradient(90deg,#ffff00,#ffaa00)}
    .peluru.double{width:12px;height:4px;box-shadow:0 0 12px rgba(100,255,255,.9);background:linear-gradient(90deg,#00ffff,#0088ff)}
    .peluru.triple{width:10px;height:4px;box-shadow:0 0 10px rgba(255,100,255,.9);background:linear-gradient(90deg,#ff00ff,#8800ff)}
    .peluru.quad{width:8px;height:4px;box-shadow:0 0 8px rgba(255,255,100,.9);background:linear-gradient(90deg,#ffff00,#ff8800)}
    .enemy-bullet{position:absolute;width:14px;height:4px;border-radius:6px;box-shadow:0 0 14px rgba(255,50,50,.9);background:linear-gradient(90deg,#ff5555,#ff0000)}

    /* enemy */
    .enemy{position:absolute;width:120px;pointer-events:none;transform:scaleX(-1)} /* Musuh terbalik */
    .boss{position:absolute;width:300px;pointer-events:none;transform:scaleX(-1)} /* Boss lebih besar */
    .megaboss{position:absolute;width:400px;pointer-events:none;transform:scaleX(-1)} /* Mega Boss lebih besar */

    /* ui/menu */
    .menu-container{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;align-items:center;gap:80px;z-index:var(--ui-z)}
    .menu{display:flex;flex-direction:column;gap:30px}
    .btn{width:400px;padding:20px 0;background:linear-gradient(#6b6b6b,#4d4d4d);color:#000;font-size:40px;font-weight:700;text-align:center;border-radius:10px;cursor:pointer;user-select:none;transition:all 0.2s ease}
    .btn:hover{transform:scale(1.03);color:#fff}

    /* Game Title */
    .game-title{color:#fff;text-align:center}
    .game-title h1{font-size:72px;font-weight:800;margin:0;text-shadow:0 0 20px #2dd4ff, 0 0 40px #1e90ff;letter-spacing:4px}
    .game-title p{font-size:24px;margin:10px 0 0;color:#ccc;font-weight:600}

    #scoreBoard{position:fixed;top:20px;left:50%;transform:translateX(-50%);color:#fff;font-size:36px;font-weight:700;display:none;z-index:var(--ui-z);text-align:center}
    #highScore{position:fixed;top:70px;left:50%;transform:translateX(-50%);color:#ccc;font-size:20px;font-weight:700;display:none;z-index:var(--ui-z);text-align:center}

    /* exit button in-game */
    #exitBtn{position:fixed;top:18px;right:18px;padding:8px 14px;background:#ff3b3b;color:#fff;border-radius:8px;font-weight:700;cursor:pointer;display:none;z-index:var(--ui-z)}
    #exitBtn:hover{background:#ff5b5b}

    /* HP BENSIN */
    #hpContainer{position:fixed;top:18px;left:18px;width:260px;height:28px;background:var(--hp-bg);border-radius:20px;padding:4px;display:none;z-index:var(--ui-z);box-shadow:0 0 10px rgba(0,150,255,.25)}
    #hpBar{width:100%;height:100%;border-radius:16px;background:linear-gradient(90deg,var(--hp-fill-start),var(--hp-fill-end));transition:width .35s ease-out}

    /* skin panel */
    #skinPanel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(10,10,10,.95);padding:28px;border-radius:14px;display:none;flex-direction:column;gap:18px;align-items:center;z-index:var(--ui-z);max-height:80vh;overflow-y:auto}
    .skinRow{display:flex;gap:18px;flex-wrap:wrap;justify-content:center}
    .skinThumb{width:140px;border-radius:10px;cursor:pointer;transition:transform .12s ease,filter .12s ease}
    .skinThumb:hover{transform:scale(1.06)}
    .locked{filter:grayscale(80%) opacity(.45);cursor:not-allowed}
    .skin-category{width:100%;text-align:center;font-size:24px;font-weight:700;margin:20px 0 10px;color:#2dd4ff;border-bottom:2px solid #2dd4ff;padding-bottom:5px}

    /* upgrade panel */
    #upgradePanel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(10,10,10,.95);padding:28px;border-radius:14px;display:none;flex-direction:column;gap:18px;align-items:center;z-index:var(--ui-z);max-height:80vh;overflow-y:auto;color:#fff}
    .upgrade-item{display:flex;justify-content:space-between;align-items:center;width:100%;padding:15px;background:rgba(50,50,50,0.7);border-radius:10px;margin-bottom:10px}
    .upgrade-info{flex:1}
    .upgrade-title{font-size:20px;font-weight:700;margin-bottom:5px}
    .upgrade-desc{font-size:14px;color:#ccc}
    .upgrade-level{font-size:14px;color:#2dd4ff;margin-top:5px}
    .upgrade-cost{font-size:18px;font-weight:700;color:#ffcc00;margin-right:15px}
    .upgrade-btn{padding:8px 16px;background:linear-gradient(#4CAF50,#2E7D32);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:700}
    .upgrade-btn:disabled{background:linear-gradient(#757575,#424242);color:#aaa;cursor:not-allowed}

    /* info panel */
    #infoPanel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(10,10,10,.95);padding:28px;border-radius:14px;display:none;flex-direction:column;gap:18px;align-items:center;z-index:var(--ui-z);max-width:80vw;max-height:80vh;overflow-y:auto;color:#fff}
    #infoPanel h2{margin:0 0 10px}
    #infoPanel p{text-align:center;margin:0 0 15px;line-height:1.4}
    .team-info{background:rgba(30,30,30,0.8);padding:20px;border-radius:10px;margin-top:10px;width:100%}
    .team-member{margin:10px 0;padding:8px;background:rgba(50,50,50,0.5);border-radius:5px}

    /* game over overlay */
    #gameOver{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:9999;color:#fff}
    #gameOver h1{font-size:56px;margin:0 0 16px}
    #gameOver p{margin:0 0 22px}

    /* toast unlock */
    #toast{position:fixed;right:20px;bottom:20px;padding:12px 18px;border-radius:10px;background:#1e90ff;color:#fff;display:none;z-index:var(--ui-z)}

    /* story mode selection */
    #storyModeSelection{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:9999;color:#fff}
    .character-selection{display:flex;gap:40px;margin:30px 0}
    .character-option{text-align:center;cursor:pointer;transition:transform 0.2s ease}
    .character-option:hover{transform:scale(1.05)}
    .character-img{width:180px;height:180px;border-radius:10px;border:3px solid #2dd4ff;object-fit:cover}
    .character-name{font-size:20px;margin-top:10px;font-weight:700}
    .story-text{max-width:800px;text-align:center;margin:20px 0;line-height:1.6;font-size:18px}
    .story-title{font-size:42px;margin-bottom:20px;color:#2dd4ff}

    /* boss hp bar */
    #bossHPBar{position:fixed;top:120px;left:50%;transform:translateX(-50%);width:300px;height:20px;background:#333;border-radius:10px;padding:3px;z-index:100;display:none}
    #bossHPFill{width:100%;height:100%;border-radius:8px;background:linear-gradient(90deg, #ff3333, #ff0000);transition:width 0.3s ease}
    #bossHPText{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;font-weight:bold}

    /* boss warning */
    #bossWarning{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,50,50,0.9);color:#fff;padding:20px 40px;border-radius:10px;font-size:32px;font-weight:700;z-index:1000;display:none;animation:pulseWarning 1s infinite}
    @keyframes pulseWarning{0%{transform:translate(-50%,-50%) scale(1);}50%{transform:translate(-50%,-50%) scale(1.1);}100%{transform:translate(-50%,-50%) scale(1);}}

    /* small responsive tweak */
    @media (max-width:1200px){
        .menu-container{flex-direction:column;gap:40px}
        .game-title h1{font-size:56px}
        .game-title p{font-size:20px}
        .character-selection{flex-direction:column;gap:20px}
    }
    @media (max-width:700px){
        .menu{left:20px}
        .btn{width:300px;font-size:28px}
        #player{width:120px}
        .skinThumb{width:100px}
        .game-title h1{font-size:42px}
        .game-title p{font-size:18px}
        .character-img{width:140px;height:140px}
    }
</style>
</head>
<body>

<!-- UI -->
<div id="exitBtn" onclick="backToMenu()">BACK</div>
<div id="hpContainer"><div id="hpBar"></div></div>
<div id="scoreBoard">SCORE: 0</div>
<div id="highScore">HIGH SCORE: 0</div>

<!-- Boss HP Bar -->
<div id="bossHPBar">
    <div id="bossHPFill"></div>
    <div id="bossHPText">BOSS HP: 0/0</div>
</div>

<!-- Boss Warning -->
<div id="bossWarning">BOSS INCOMING!</div>

<div class="menu-container" id="menuContainer">
    <!-- Game Title -->
    <div class="game-title">
        <h1>WORLD OF SPACE</h1>
        <p>Defend Your Territory</p>
    </div>
    
    <!-- Menu Buttons -->
    <div class="menu" id="menu">
        <div class="btn" onclick="startGameModeSelection()">START</div>
        <div class="btn" onclick="openSkinMenu()">SKIN</div>
        <div class="btn" onclick="openUpgradeMenu()">UPGRADE</div>
        <div class="btn" onclick="openInfoMenu()">INFO</div>
        <div class="btn" onclick="exitGame()">EXIT</div>
    </div>
</div>

<!-- Story Mode Selection -->
<div id="storyModeSelection">
    <div class="story-title">PILIH MODE PERMAINAN</div>
    <div class="story-text">
        Pilih mode permainan yang ingin Anda mainkan. Mode Story akan memberikan pengalaman bermain dengan cerita yang menarik, sementara Free Play memungkinkan Anda bermain tanpa batasan cerita.
    </div>
    <div style="display:flex;gap:20px;margin-top:20px">
        <div class="btn" onclick="startStoryMode()">STORY MODE</div>
        <div class="btn" onclick="startFreePlay()">FREE PLAY</div>
    </div>
    <div class="btn" style="width:220px;margin-top:20px" onclick="backToMainMenu()">Kembali</div>
</div>

<!-- Character Selection -->
<div id="characterSelection" style="position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:9999;color:#fff">
    <div class="story-title">PILIH KARAKTER</div>
    <div class="story-text">
        Pilih karakter yang akan Anda gunakan dalam petualangan ini. Setiap karakter memiliki keunikan tersendiri.
    </div>
    <div class="character-selection">
        <div class="character-option" onclick="selectCharacter('male')">
            <div style="width:180px;height:180px;border-radius:10px;border:3px solid #2dd4ff;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg, #1e3c72, #2a5298);font-size:80px;">üöÄ</div>
            <div class="character-name">Kapten Alex</div>
        </div>
        <div class="character-option" onclick="selectCharacter('female')">
            <div style="width:180px;height:180px;border-radius:10px;border:3px solid #2dd4ff;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg, #c33764, #e9396d);font-size:80px;">üë©‚ÄçüöÄ</div>
            <div class="character-name">Letnan Sarah</div>
        </div>
    </div>
    <div class="btn" style="width:220px;margin-top:20px" onclick="backToModeSelection()">Kembali</div>
</div>

<!-- Player -->
<img id="player" src="normal1.png" alt="player">

<!-- Skin Panel -->
<div id="skinPanel">
    <div style="font-size:28px;font-weight:700;color:#fff">Pilih Skin Pesawat</div>
    
    <div class="skin-category">Normal Skin</div>
    <div class="skinRow">
        <div style="text-align:center">
            <img id="normal0" class="skinThumb" src="normal1.png" onclick="trySelectNormalSkin(0)">
            <div style="font-size:14px;margin-top:6px;color:#fff">Basic</div>
        </div>
        <div style="text-align:center">
            <img id="normal1" class="skinThumb locked" src="normal2.png" onclick="trySelectNormalSkin(1)">
            <div id="normal1Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (100)</div>
        </div>
        <div style="text-align:center">
            <img id="normal2" class="skinThumb locked" src="normal3.png" onclick="trySelectNormalSkin(2)">
            <div id="normal2Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (200)</div>
        </div>
        <div style="text-align:center">
            <img id="normal3" class="skinThumb locked" src="normal4.png" onclick="trySelectNormalSkin(3)">
            <div id="normal3Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (350)</div>
        </div>
        <div style="text-align:center">
            <img id="normal4" class="skinThumb locked" src="normal5.png" onclick="trySelectNormalSkin(4)">
            <div id="normal4Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (500)</div>
        </div>
        <div style="text-align:center">
            <img id="normal5" class="skinThumb locked" src="normal6.png" onclick="trySelectNormalSkin(5)">
            <div id="normal5Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (700)</div>
        </div>
        <div style="text-align:center">
            <img id="normal6" class="skinThumb locked" src="normal7.png" onclick="trySelectNormalSkin(6)">
            <div id="normal6Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (900)</div>
        </div>
        <div style="text-align:center">
            <img id="normal7" class="skinThumb locked" src="normal8.png" onclick="trySelectNormalSkin(7)">
            <div id="normal7Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (1200)</div>
        </div>
        <div style="text-align:center">
            <img id="normal8" class="skinThumb locked" src="normal9.png" onclick="trySelectNormalSkin(8)">
            <div id="normal8Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (1500)</div>
        </div>
        <div style="text-align:center">
            <img id="normal9" class="skinThumb locked" src="normal10.png" onclick="trySelectNormalSkin(9)">
            <div id="normal9Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (1800)</div>
        </div>
        <div style="text-align:center">
            <img id="normal10" class="skinThumb locked" src="normal11.png" onclick="trySelectNormalSkin(10)">
            <div id="normal10Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (2200)</div>
        </div>
        <div style="text-align:center">
            <img id="normal11" class="skinThumb locked" src="normal12.png" onclick="trySelectNormalSkin(11)">
            <div id="normal11Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (2600)</div>
        </div>
        <div style="text-align:center">
            <img id="normal12" class="skinThumb locked" src="normal13.png" onclick="trySelectNormalSkin(12)">
            <div id="normal12Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (3000)</div>
        </div>
        <div style="text-align:center">
            <img id="normal13" class="skinThumb locked" src="normal14.png" onclick="trySelectNormalSkin(13)">
            <div id="normal13Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (3500)</div>
        </div>
        <div style="text-align:center">
            <img id="normal14" class="skinThumb locked" src="normal15.png" onclick="trySelectNormalSkin(14)">
            <div id="normal14Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (4000)</div>
        </div>
    </div>
    
    <div class="skin-category">Fantasy Skin</div>
    <div class="skinRow">
        <div style="text-align:center">
            <img id="skin0" class="skinThumb" src="skin1.png" onclick="trySelectSkin(0)">
            <div style="font-size:14px;margin-top:6px;color:#fff">Basic Fantasy</div>
        </div>
        <div style="text-align:center">
            <img id="skin1" class="skinThumb locked" src="skin2.png" onclick="trySelectSkin(1)">
            <div id="skin1Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (150)</div>
        </div>
        <div style="text-align:center">
            <img id="skin2" class="skinThumb locked" src="skin3.png" onclick="trySelectSkin(2)">
            <div id="skin2Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (300)</div>
        </div>
        <div style="text-align:center">
            <img id="skin3" class="skinThumb locked" src="skin4.png" onclick="trySelectSkin(3)">
            <div id="skin3Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (500)</div>
        </div>
        <div style="text-align:center">
            <img id="skin4" class="skinThumb locked" src="skin5.png" onclick="trySelectSkin(4)">
            <div id="skin4Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (700)</div>
        </div>
        <div style="text-align:center">
            <img id="skin5" class="skinThumb locked" src="skin6.png" onclick="trySelectSkin(5)">
            <div id="skin5Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (1000)</div>
        </div>
        <div style="text-align:center">
            <img id="skin6" class="skinThumb locked" src="skin7.png" onclick="trySelectSkin(6)">
            <div id="skin6Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (1500)</div>
        </div>
        <div style="text-align:center">
            <img id="skin7" class="skinThumb locked" src="skin8.png" onclick="trySelectSkin(7)">
            <div id="skin7Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (2000)</div>
        </div>
        <div style="text-align:center">
            <img id="skin8" class="skinThumb locked" src="skin9.png" onclick="trySelectSkin(8)">
            <div id="skin8Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (2500)</div>
        </div>
        <div style="text-align:center">
            <img id="skin9" class="skinThumb locked" src="skin10.png" onclick="trySelectSkin(9)">
            <div id="skin9Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (3000)</div>
        </div>
        <div style="text-align:center">
            <img id="skin10" class="skinThumb locked" src="skin11.png" onclick="trySelectSkin(10)">
            <div id="skin10Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (4000)</div>
        </div>
        <div style="text-align:center">
            <img id="skin11" class="skinThumb locked" src="skin12.png" onclick="trySelectSkin(11)">
            <div id="skin11Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (5000)</div>
        </div>
        <div style="text-align:center">
            <img id="skin12" class="skinThumb locked" src="skin13.png" onclick="trySelectSkin(12)">
            <div id="skin12Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (6000)</div>
        </div>
        <div style="text-align:center">
            <img id="skin13" class="skinThumb locked" src="skin14.png" onclick="trySelectSkin(13)">
            <div id="skin13Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (7000)</div>
        </div>
        <div style="text-align:center">
            <img id="skin14" class="skinThumb locked" src="skin15.png" onclick="trySelectSkin(14)">
            <div id="skin14Label" style="font-size:14px;margin-top:6px;color:#ccc">Locked (8000)</div>
        </div>
    </div>
    <div class="btn" style="width:220px;margin-top:12px" onclick="closeSkinMenu()">Tutup</div>
</div>

<!-- Upgrade Panel -->
<div id="upgradePanel">
    <div style="font-size:28px;font-weight:700;color:#fff">UPGRADE PESAWAT</div>
    <div style="color:#ccc;margin-bottom:20px">Gunakan High Score untuk upgrade. High Score akan berkurang sesuai biaya upgrade.</div>
    <div style="color:#ffcc00;font-size:18px;margin-bottom:20px;font-weight:700">High Score Anda: <span id="currentHighScore">0</span></div>
    
    <div class="upgrade-item">
        <div class="upgrade-info">
            <div class="upgrade-title">Health Boost</div>
            <div class="upgrade-desc">Tambah maksimum HP (+50 HP per level)</div>
            <div class="upgrade-level">Level: <span id="healthLevel">0</span>/10</div>
        </div>
        <div class="upgrade-cost" id="healthCost">Cost: 200</div>
        <button class="upgrade-btn" onclick="upgradeHealth()" id="healthUpgradeBtn">UPGRADE</button>
    </div>
    
    <div class="upgrade-item">
        <div class="upgrade-info">
            <div class="upgrade-title">Bullet Power</div>
            <div class="upgrade-desc">Tembakan lebih kuat (hancurkan meteor level tinggi)</div>
            <div class="upgrade-level">Level: <span id="bulletLevel">0</span>/5</div>
        </div>
        <div class="upgrade-cost" id="bulletCost">Cost: 300</div>
        <button class="upgrade-btn" onclick="upgradeBullet()" id="bulletUpgradeBtn">UPGRADE</button>
    </div>
    
    <div class="upgrade-item">
        <div class="upgrade-info">
            <div class="upgrade-title">Movement Speed</div>
            <div class="upgrade-desc">Pesawat bergerak lebih cepat (+1 speed per level)</div>
            <div class="upgrade-level">Level: <span id="speedLevel">0</span>/8</div>
        </div>
        <div class="upgrade-cost" id="speedCost">Cost: 150</div>
        <button class="upgrade-btn" onclick="upgradeSpeed()" id="speedUpgradeBtn">UPGRADE</button>
    </div>
    
    <div class="upgrade-item">
        <div class="upgrade-info">
            <div class="upgrade-title">Double Shot</div>
            <div class="upgrade-desc">Tembakan ganda ke atas dan bawah</div>
            <div class="upgrade-level">Level: <span id="doubleLevel">0</span>/1</div>
        </div>
        <div class="upgrade-cost" id="doubleCost">Cost: 500</div>
        <button class="upgrade-btn" onclick="upgradeDouble()" id="doubleUpgradeBtn">UPGRADE</button>
    </div>
    
    <div class="upgrade-item">
        <div class="upgrade-info">
            <div class="upgrade-title">Triple Shot</div>
            <div class="upgrade-desc">Tembakan tiga arah (tengah, atas, bawah)</div>
            <div class="upgrade-level">Level: <span id="tripleLevel">0</span>/1</div>
        </div>
        <div class="upgrade-cost" id="tripleCost">Cost: 800</div>
        <button class="upgrade-btn" onclick="upgradeTriple()" id="tripleUpgradeBtn">UPGRADE</button>
    </div>
    
    <div class="upgrade-item">
        <div class="upgrade-info">
            <div class="upgrade-title">Quad Shot</div>
            <div class="upgrade-desc">Tembakan empat arah (semua penjuru)</div>
            <div class="upgrade-level">Level: <span id="quadLevel">0</span>/1</div>
        </div>
        <div class="upgrade-cost" id="quadCost">Cost: 1200</div>
        <button class="upgrade-btn" onclick="upgradeQuad()" id="quadUpgradeBtn">UPGRADE</button>
    </div>
    
    <div class="upgrade-item">
        <div class="upgrade-info">
            <div class="upgrade-title">Rebirth</div>
            <div class="upgrade-desc">Reset semua upgrade, dapatkan 2x damage dan score</div>
            <div class="upgrade-level">Level: <span id="rebirthLevel">0</span>/5</div>
        </div>
        <div class="upgrade-cost" id="rebirthCost">Cost: 5000</div>
        <button class="upgrade-btn" onclick="upgradeRebirth()" id="rebirthUpgradeBtn">REBIRTH</button>
    </div>
    
    <div style="margin-top:20px;color:#ffcc00;font-weight:700" id="upgradeStatus">Pilih upgrade yang diinginkan</div>
    
    <div class="btn" style="width:220px;margin-top:12px" onclick="closeUpgradeMenu()">Tutup</div>
</div>

<!-- Info Panel -->
<div id="infoPanel">
    <h2>INFORMASI GAME</h2>
    <p>Selamat datang di WORLD OF SPACE!<br>Kendalikan pesawat Anda dan hancurkan meteor yang datang.</p>
    
    <p><strong>Kontrol:</strong><br>
        W - Naik<br>
        S - Turun<br>
        Spasi - Tembak
    </p>
    
    <p>Hindari meteor dan musuh yang menyerang Anda.<br>Kumpulkan skor untuk membuka skin baru dan upgrade!</p>
    
    <div class="team-info">
        <h3>Informasi Kelompok</h3>
        <p><strong>JURUSAN:</strong> Sistem Komputer</p>
        <p><strong>Mata Kuliah:</strong> Pemograman Aplikasi Pemograman</p>
        <p><strong>Dosen Pembimbing:</strong> Rio Septian Hardinata, S.Kom., M.Kom</p>
        
        <div class="team-member">
            <strong>Ketua Kelompok:</strong><br>
            Dean Fahrezi Rambe (NPM: 2414370174)
        </div>
        
        <div class="team-member">
            <strong>Anggota:</strong><br>
            Yuli Junika (NPM: 2414370156)
        </div>
        
        <div class="team-member">
            <strong>Anggota:</strong><br>
            Reni Agustina (NPM: 2414370116)
        </div>
    </div>
    
    <div class="btn" style="width:220px;margin-top:12px" onclick="closeInfoMenu()">Tutup</div>
</div>

<!-- Game Over overlay -->
<div id="gameOver">
    <h1>GAME OVER</h1>
    <p id="finalScore">Score: 0</p>
    <div style="display:flex;gap:12px">
        <div class="btn" style="width:180px" onclick="restartGame()">Retry</div>
        <div class="btn" style="width:180px" onclick="backToMenu()">Menu</div>
    </div>
</div>

<!-- toast -->
<div id="toast"></div>

<!-- Audio Elements -->
<audio id="bgMusic" loop>
    <source src="soundtrack.mp3" type="audio/mpeg">
</audio>
<audio id="gameplayMusic" loop>
    <source src="gameplay.mp3" type="audio/mpeg">
</audio>
<audio id="shootSound">
    <source src="dor.mp3" type="audio/mpeg">
</audio>
<audio id="breakSound">
    <source src="break.mp3" type="audio/mpeg">
</audio>
<audio id="clickSound">
    <source src="click.mp3" type="audio/mpeg">
</audio>
<audio id="gameoverSound">
    <source src="gameover.mp3" type="audio/mpeg">
</audio>
<audio id="launchSound">
    <source src="launch.mp3" type="audio/mpeg">
</audio>
<audio id="bossMusic" loop>
    <source src="boss.mp3" type="audio/mpeg">
</audio>
<audio id="bossWarningSound">
    <source src="warning.mp3" type="audio/mpeg">
</audio>

<script>
/* ================= BASE SETUP ================= */
const player = document.getElementById('player');
const scoreBoard = document.getElementById('scoreBoard');
const highScoreBoard = document.getElementById('highScore');
const hpBar = document.getElementById('hpBar');
const hpContainer = document.getElementById('hpContainer');
const exitBtn = document.getElementById('exitBtn');
const menuContainer = document.getElementById('menuContainer');
const menu = document.getElementById('menu');
const skinPanel = document.getElementById('skinPanel');
const upgradePanel = document.getElementById('upgradePanel');
const infoPanel = document.getElementById('infoPanel');
const gameOver = document.getElementById('gameOver');
const finalScoreText = document.getElementById('finalScore');
const toast = document.getElementById('toast');
const storyModeSelection = document.getElementById('storyModeSelection');
const characterSelection = document.getElementById('characterSelection');
const bossHPBar = document.getElementById('bossHPBar');
const bossHPFill = document.getElementById('bossHPFill');
const bossHPText = document.getElementById('bossHPText');
const bossWarning = document.getElementById('bossWarning');

// Audio elements
const bgMusic = document.getElementById('bgMusic');
const gameplayMusic = document.getElementById('gameplayMusic');
const shootSound = document.getElementById('shootSound');
const breakSound = document.getElementById('breakSound');
const clickSound = document.getElementById('clickSound');
const gameoverSound = document.getElementById('gameoverSound');
const launchSound = document.getElementById('launchSound');
const bossMusic = document.getElementById('bossMusic');
const bossWarningSound = document.getElementById('bossWarningSound');

let gameMeteors = [];
let gameEnemies = [];
let enemyBullets = [];
let score = 0;
let highScore = 0;
let maxHP = 100;
let currentHP = maxHP;
let selectedSkin = 'normal1.png';
let normalSkinUnlocked = {0:true,1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false,9:false,10:false,11:false,12:false,13:false,14:false};
let fantasySkinUnlocked = {0:true,1:false,2:false,3:false,4:false,5:false,6:false,7:false,8:false,9:false,10:false,11:false,12:false,13:false,14:false};
let keys = {};
let speed = 6;
let gameRunning = false;
let isStoryMode = false;
let selectedCharacter = 'male';
let currentStoryStage = 0;
let bossActive = false;
let bossHP = 1000;
let maxBossHP = 1000;
let bossType = ''; // 'boss' or 'megaboss'
let nextBossScore = 1500; // Skor pertama boss muncul
let bossDefeatedCount = 0; // Jumlah boss yang sudah dikalahkan

// Upgrade system - BISA BERKALI-KALI
let upgrades = {
    health: { level: 0, baseCost: 200, maxLevel: 10 },
    bullet: { level: 0, baseCost: 300, maxLevel: 5 },
    speed: { level: 0, baseCost: 150, maxLevel: 8 },
    double: { level: 0, baseCost: 500, maxLevel: 1 },
    triple: { level: 0, baseCost: 800, maxLevel: 1 },
    quad: { level: 0, baseCost: 1200, maxLevel: 1 },
    rebirth: { level: 0, baseCost: 5000, maxLevel: 5 }
};

let bulletUpgraded = false;
let doubleShot = false;
let tripleShot = false;
let quadShot = false;
let rebirthMultiplier = 1;

/* create stars */
function createStar(){
    const s = document.createElement('div');
    s.className='star';
    s.style.left = Math.random()*100 + 'vw';
    s.style.top = '-10px';
    s.style.animationDuration = (5 + Math.random()*7) + 's';
    document.body.appendChild(s);
    setTimeout(()=>s.remove(),15000);
}
setInterval(createStar,120);

/* =================== METEOR CREATION =================== */
function createMeteor(){
    const meteor = document.createElement('img');
    meteor.className='meteor';
    meteor.dataset.level = 1 + Math.floor(Math.random()*6); // 1 to 6
    meteor.src = `tingkat${meteor.dataset.level}.png`;
    meteor.style.top = (50 + (Math.random()*70 - 35)) + 'vh'; // spread vertical
    meteor.style.left = (window.innerWidth + 80) + 'px';
    meteor.style.transform = `rotate(${Math.random()*360}deg)`;
    const duration = 3800 + Math.random()*4200;
    meteor.style.transition = `transform ${duration}ms linear, left ${duration}ms linear`;
    document.body.appendChild(meteor);
    gameMeteors.push(meteor);

    // move to left
    requestAnimationFrame(()=> {
        meteor.style.left = '-160px';
        meteor.style.transform = `rotate(${Math.random()*720 - 360}deg)`;
    });

    // auto-remove after duration+500
    setTimeout(()=> {
        if (document.body.contains(meteor)) {
            meteor.remove();
            gameMeteors = gameMeteors.filter(m => m !== meteor);
        }
    }, duration+600);
}

// Create meteors in menu
function createMenuMeteor(){
    const meteor = document.createElement('img');
    meteor.className='meteor';
    meteor.dataset.level = 1 + Math.floor(Math.random()*6);
    meteor.src = `tingkat${meteor.dataset.level}.png`;
    meteor.style.top = (Math.random()*100) + 'vh';
    meteor.style.left = (window.innerWidth + 80) + 'px';
    meteor.style.transform = `rotate(${Math.random()*360}deg)`;
    const duration = 6000 + Math.random()*6000;
    meteor.style.transition = `transform ${duration}ms linear, left ${duration}ms linear`;
    document.body.appendChild(meteor);

    // move to left
    requestAnimationFrame(()=> {
        meteor.style.left = '-160px';
        meteor.style.transform = `rotate(${Math.random()*720 - 360}deg)`;
    });

    // auto-remove after duration+500
    setTimeout(()=> {
        if (document.body.contains(meteor)) {
            meteor.remove();
        }
    }, duration+600);
}

let meteorInterval;
let menuMeteorInterval;
function startMeteorSpawner(){ meteorInterval = setInterval(createMeteor, 1100); }
function stopMeteorSpawner(){ clearInterval(meteorInterval); }
function startMenuMeteorSpawner(){ menuMeteorInterval = setInterval(createMenuMeteor, 2000); }
function stopMenuMeteorSpawner(){ clearInterval(menuMeteorInterval); }

/* =================== ENEMY CREATION =================== */
function createEnemy(){
    const enemyTypes = ['musuh1.png', 'musuh2.png', 'musuh3.png', 'satelit1.png', 'satelit2.png'];
    const enemyType = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
    
    const enemy = document.createElement('img');
    enemy.className='enemy';
    enemy.src = enemyType;
    enemy.style.top = (Math.random() * (window.innerHeight - 120)) + 'px';
    enemy.style.left = (window.innerWidth + 80) + 'px';
    // Musuh sudah terbalik dari CSS dengan transform:scaleX(-1)
    document.body.appendChild(enemy);
    gameEnemies.push(enemy);

    // Move enemy to left
    const duration = 8000 + Math.random()*4000;
    enemy.style.transition = `left ${duration}ms linear`;
    
    requestAnimationFrame(()=> {
        enemy.style.left = '-160px';
    });

    // Enemy shooting interval
    const shootInterval = setInterval(() => {
        if (!document.body.contains(enemy) || !gameRunning) {
            clearInterval(shootInterval);
            return;
        }
        enemyShoot(enemy);
    }, 1500 + Math.random()*1000);

    // Auto-remove after duration+500
    setTimeout(()=> {
        if (document.body.contains(enemy)) {
            enemy.remove();
            gameEnemies = gameEnemies.filter(e => e !== enemy);
        }
        clearInterval(shootInterval);
    }, duration+600);
}

/* =================== BOSS CREATION =================== */
function createBoss(type = 'boss'){
    if (bossActive) return;
    
    bossActive = true;
    bossType = type;
    
    if (type === 'boss') {
        bossHP = 1000 + (bossDefeatedCount * 200); // HP meningkat setiap boss dikalahkan
        maxBossHP = bossHP;
    } else {
        bossHP = 2000 + (bossDefeatedCount * 300); // HP meningkat setiap boss dikalahkan
        maxBossHP = bossHP;
    }
    
    // Show boss warning
    showBossWarning(type);
    
    // Set timeout untuk spawn boss setelah warning
    setTimeout(() => {
        if (!gameRunning) return;
        
        // Show boss HP bar
        bossHPBar.style.display = 'block';
        updateBossHPBar();
        
        // Switch to boss music
        gameplayMusic.pause();
        bossMusic.currentTime = 0;
        bossMusic.play();
        
        const boss = document.createElement('img');
        boss.className = type === 'boss' ? 'boss' : 'megaboss';
        boss.src = type === 'boss' ? 'bos.png' : 'megabos.png';
        boss.style.top = '50%';
        boss.style.left = (window.innerWidth + 80) + 'px';
        boss.style.transform = 'translateY(-50%) scaleX(-1)';
        document.body.appendChild(boss);
        gameEnemies.push(boss);

        // Move boss to center-right
        const duration = 5000;
        boss.style.transition = `left ${duration}ms ease-out`;
        
        requestAnimationFrame(()=> {
            boss.style.left = (window.innerWidth - (type === 'boss' ? 400 : 500)) + 'px';
        });

        // Boss shooting interval - more frequent and powerful
        const shootInterval = setInterval(() => {
            if (!document.body.contains(boss) || !gameRunning || !bossActive) {
                clearInterval(shootInterval);
                return;
            }
            bossShoot(boss);
        }, type === 'boss' ? 800 : 600);

        // Boss movement pattern
        let movingDown = true;
        const moveInterval = setInterval(() => {
            if (!document.body.contains(boss) || !gameRunning || !bossActive) {
                clearInterval(moveInterval);
                return;
            }
            
            const currentTop = parseInt(boss.style.top);
            if (movingDown) {
                boss.style.top = (currentTop + 2) + 'px';
                if (currentTop > window.innerHeight - (type === 'boss' ? 300 : 400)) movingDown = false;
            } else {
                boss.style.top = (currentTop - 2) + 'px';
                if (currentTop < 100) movingDown = true;
            }
        }, 50);

        // Auto-remove if boss leaves screen
        setTimeout(()=> {
            if (document.body.contains(boss)) {
                boss.remove();
                gameEnemies = gameEnemies.filter(e => e !== boss);
                bossActive = false;
                bossHPBar.style.display = 'none';
                // Switch back to normal music
                bossMusic.pause();
                gameplayMusic.currentTime = 0;
                gameplayMusic.play();
            }
            clearInterval(shootInterval);
            clearInterval(moveInterval);
        }, 60000); // Boss stays for 60 seconds max
    }, 3000); // Delay 3 detik setelah warning
}

function showBossWarning(type) {
    bossWarning.textContent = type === 'boss' ? "BOSS INCOMING!" : "MEGA BOSS INCOMING!";
    bossWarning.style.display = 'block';
    
    // Play warning sound
    if (bossWarningSound) {
        bossWarningSound.currentTime = 0;
        bossWarningSound.play();
    }
    
    // Hide warning after 3 seconds
    setTimeout(() => {
        bossWarning.style.display = 'none';
    }, 3000);
}

function bossShoot(boss){
    if (!gameRunning) return;
    
    // Boss shoots multiple bullets
    const bulletCount = bossType === 'boss' ? 3 : 5;
    for (let i = 0; i < bulletCount; i++) {
        const p = document.createElement('div');
        p.className = 'enemy-bullet';
        p.style.width = bossType === 'boss' ? '20px' : '25px';
        p.style.height = bossType === 'boss' ? '6px' : '8px';
        
        // Compute boss's position
        const er = boss.getBoundingClientRect();
        const startLeft = er.left + 8;
        const startTop = er.top + er.height/2 - 3 + (i-Math.floor(bulletCount/2))*30;
        p.style.left = startLeft + 'px';
        p.style.top = startTop + 'px';
        document.body.appendChild(p);
        enemyBullets.push(p);

        const speedBul = bossType === 'boss' ? 10 : 12;
        const it = setInterval(()=> {
            if (!document.body.contains(p)) { 
                clearInterval(it); 
                enemyBullets = enemyBullets.filter(b => b !== p);
                return; 
            }
            
            p.style.left = (p.offsetLeft - speedBul) + 'px';
            
            // Collision with player
            if (isCollide(p, player)){
                // Damage player
                const dmg = bossType === 'boss' ? 20 : 30;
                reduceHP(dmg);
                p.remove();
                clearInterval(it);
                enemyBullets = enemyBullets.filter(b => b !== p);
                
                // Spawn explosion at collision center
                const pr = player.getBoundingClientRect();
                const cx = (Math.max(pr.left, er.left) + Math.min(pr.right, er.right))/2;
                const cy = (Math.max(pr.top, er.top) + Math.min(pr.bottom, er.bottom))/2;
                spawnExplosion(cx, cy, 20);
            }
            
            if (p.offsetLeft < -50){
                p.remove();
                clearInterval(it);
                enemyBullets = enemyBullets.filter(b => b !== p);
            }
        }, 24);
    }
}

let enemyInterval;
function startEnemySpawner(){ 
    enemyInterval = setInterval(createEnemy, 3000); 
}
function stopEnemySpawner(){ 
    clearInterval(enemyInterval); 
    bossActive = false;
    bossHPBar.style.display = 'none';
}

/* =================== BOSS SPAWN LOGIC BERDASARKAN SKOR =================== */
function checkBossSpawn() {
    if (!gameRunning || bossActive) return;
    
    // Cek jika skor mencapai threshold untuk spawn boss
    if (score >= nextBossScore) {
        // Tentukan jenis boss (alternate antara boss dan megaboss)
        const bossTypeToSpawn = (bossDefeatedCount % 2 === 0) ? 'boss' : 'megaboss';
        createBoss(bossTypeToSpawn);
        
        // Set next boss score (1500, 3000, 4500, 6000, dst)
        nextBossScore += 1500;
    }
}

/* =================== ENEMY SHOOTING =================== */
function enemyShoot(enemy){
    if (!gameRunning) return;
    
    const p = document.createElement('div');
    p.className = 'enemy-bullet';
    
    // Compute enemy's center-left position
    const er = enemy.getBoundingClientRect();
    const startLeft = er.left + 8; // near nose
    const startTop = er.top + er.height/2 - 2;
    p.style.left = startLeft + 'px';
    p.style.top = startTop + 'px';
    document.body.appendChild(p);
    enemyBullets.push(p);

    const speedBul = 12;
    const it = setInterval(()=> {
        if (!document.body.contains(p)) { 
            clearInterval(it); 
            enemyBullets = enemyBullets.filter(b => b !== p);
            return; 
        }
        
        p.style.left = (p.offsetLeft - speedBul) + 'px';
        
        // Collision with player
        if (isCollide(p, player)){
            // Damage player
            const dmg = 10 + Math.floor(Math.random()*5);
            reduceHP(dmg);
            p.remove();
            clearInterval(it);
            enemyBullets = enemyBullets.filter(b => b !== p);
            
            // Spawn explosion at collision center
            const pr = player.getBoundingClientRect();
            const cx = (Math.max(pr.left, er.left) + Math.min(pr.right, er.right))/2;
            const cy = (Math.max(pr.top, er.top) + Math.min(pr.bottom, er.bottom))/2;
            spawnExplosion(cx, cy, 15);
        }
        
        if (p.offsetLeft < -50){
            p.remove();
            clearInterval(it);
            enemyBullets = enemyBullets.filter(b => b !== p);
        }
    }, 24);
}

/* =================== START / RESTART / MENU =================== */
function startGameModeSelection(){
    clickSound.currentTime = 0;
    clickSound.play();
    menuContainer.style.display = 'none';
    storyModeSelection.style.display = 'flex';
}

function backToMainMenu(){
    clickSound.currentTime = 0;
    clickSound.play();
    storyModeSelection.style.display = 'none';
    menuContainer.style.display = 'flex';
}

function backToModeSelection(){
    clickSound.currentTime = 0;
    clickSound.play();
    characterSelection.style.display = 'none';
    storyModeSelection.style.display = 'flex';
}

function startStoryMode(){
    clickSound.currentTime = 0;
    clickSound.play();
    storyModeSelection.style.display = 'none';
    characterSelection.style.display = 'flex';
    isStoryMode = true;
}

function startFreePlay(){
    clickSound.currentTime = 0;
    clickSound.play();
    storyModeSelection.style.display = 'none';
    isStoryMode = false;
    startGame();
}

function selectCharacter(gender){
    clickSound.currentTime = 0;
    clickSound.play();
    selectedCharacter = gender;
    characterSelection.style.display = 'none';
    startGame();
}

function startGame(){
    menuContainer.style.display='none';
    scoreBoard.style.display='block';
    highScoreBoard.style.display='block';
    exitBtn.style.display='block';
    hpContainer.style.display='block';
    player.src = selectedSkin;
    player.style.display='block';
    
    // Reset boss variables
    bossActive = false;
    nextBossScore = 1500;
    bossDefeatedCount = 0;
    
    // Play launch sound
    launchSound.currentTime = 0;
    launchSound.play();
    
    // Stop menu music and start gameplay music
    bgMusic.pause();
    gameplayMusic.currentTime = 0;
    gameplayMusic.play();
    
    // Stop menu meteors
    stopMenuMeteorSpawner();
    
    // animate player entrance
    player.style.left = '90px';
    
    // reset values when starting fresh
    score = 0; 
    updateScore();
    currentHP = maxHP; 
    updateHPBar();
    gameRunning = true;
    
    // Start spawners
    startMeteorSpawner();
    startEnemySpawner();
    
    // Show story intro if in story mode
    if (isStoryMode) {
        showStoryIntro();
    }
    
    requestAnimationFrame(gameLoop);
}

function showStoryIntro(){
    // Create story intro overlay
    const storyIntro = document.createElement('div');
    storyIntro.style.position = 'fixed';
    storyIntro.style.inset = '0';
    storyIntro.style.background = 'rgba(0,0,0,0.9)';
    storyIntro.style.display = 'flex';
    storyIntro.style.alignItems = 'center';
    storyIntro.style.justifyContent = 'center';
    storyIntro.style.flexDirection = 'column';
    storyIntro.style.zIndex = '99999';
    storyIntro.style.color = '#fff';
    storyIntro.style.textAlign = 'center';
    storyIntro.style.padding = '40px';
    
    storyIntro.innerHTML = `
        <div class="story-title">MISI PENYELAMATAN BUMI</div>
        <div class="story-text">
            <p>Tahun 2150. Bumi berada di ambang kehancuran.</p>
            <p>Serangan asteroid raksasa dan invasi alien telah mengancam keberlangsungan hidup umat manusia.</p>
            <p>Sebagai ${selectedCharacter === 'male' ? 'Kapten Alex' : 'Letnan Sarah'}, Anda ditugaskan untuk memimpin misi penyelamatan terakhir.</p>
            <p>Hancurkan semua ancaman yang mendekati Bumi dan selamatkan peradaban manusia!</p>
            <p><strong>PERINGATAN:</strong> Boss akan muncul pada skor 1500, 3000, 4500, dan seterusnya!</p>
        </div>
        <div class="btn" style="margin-top:30px" onclick="this.parentElement.remove()">MULAI MISI</div>
    `;
    
    document.body.appendChild(storyIntro);
}

function restartGame(){
    gameOver.style.display='none';
    
    // Clean up game objects
    gameMeteors.forEach(m => m.remove());
    gameMeteors = [];
    
    gameEnemies.forEach(e => e.remove());
    gameEnemies = [];
    
    enemyBullets.forEach(b => b.remove());
    enemyBullets = [];
    
    // Hide boss HP bar
    bossHPBar.style.display = 'none';
    
    startGame();
}

function backToMenu(){
    // Stop gameplay music and start menu music
    gameplayMusic.pause();
    bossMusic.pause();
    bgMusic.currentTime = 0;
    bgMusic.play();
    
    // Stop game spawners
    stopMeteorSpawner();
    stopEnemySpawner();
    
    // Clean up game objects
    gameMeteors.forEach(m => m.remove());
    gameMeteors = [];
    
    gameEnemies.forEach(e => e.remove());
    gameEnemies = [];
    
    enemyBullets.forEach(b => b.remove());
    enemyBullets = [];
    
    // Hide game UI
    scoreBoard.style.display='none';
    highScoreBoard.style.display='none';
    exitBtn.style.display='none';
    hpContainer.style.display='none';
    player.style.display='none';
    bossHPBar.style.display = 'none';
    bossWarning.style.display = 'none';
    
    // Show menu
    menuContainer.style.display='flex';
    gameOver.style.display='none';
    
    // Start menu meteors
    startMenuMeteorSpawner();
    
    gameRunning = false;
    
    // Auto save semua data
    saveAllData();
}

function exitGame(){
    // Play click sound
    clickSound.currentTime = 0;
    clickSound.play();
    
    // Auto save sebelum exit
    saveAllData();
    window.location.href = "about:blank";
}

/* =================== SMOOTH MOVEMENT (WASD) =================== */
document.addEventListener('keydown', e => {
    keys[e.key.toLowerCase()] = true;
    if (e.key === ' ') shoot();
});
document.addEventListener('keyup', e => { keys[e.key.toLowerCase()] = false; });

function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function smoothMove(){
    if (!gameRunning) return;
    // W/S vertical - BISA LEBIH TURUN LAGI
    if (keys['w']) player.style.top = (player.offsetTop - speed) + 'px';
    if (keys['s']) player.style.top = (player.offsetTop + speed) + 'px';

    // clamp to viewport - AREA LEBIH LUAS KE BAWAH
    const rect = player.getBoundingClientRect();
    let left = clamp(player.offsetLeft, 10, window.innerWidth - rect.width - 10);
    let top = clamp(player.offsetTop, 10, window.innerHeight - rect.height + 100); // Bisa lebih turun
    player.style.left = left + 'px';
    player.style.top = top + 'px';
}

/* run movement at 60FPS via animation frame */
function gameLoop(){
    if (!gameRunning) return;
    smoothMove();
    checkCollisions();
    checkBossSpawn(); // Cek spawn boss berdasarkan skor
    requestAnimationFrame(gameLoop);
}

/* =================== SHOOTING (peluru di tengah pesawat) =================== */
function shoot(){
    if (!gameRunning) return;
    
    // Play shoot sound
    shootSound.currentTime = 0;
    shootSound.play();
    
    // Determine bullet type and create bullets accordingly
    if (quadShot) {
        createQuadBullets();
    } else if (tripleShot) {
        createTripleBullets();
    } else if (doubleShot) {
        createDoubleBullets();
    } else {
        createSingleBullet();
    }
}

function createSingleBullet(){
    const p = document.createElement('div');
    p.className = bulletUpgraded ? 'peluru upgraded' : 'peluru';
    
    // compute player's center-right position
    const pr = player.getBoundingClientRect();
    const startLeft = pr.left + pr.width - 8; // near nose
    const startTop = pr.top + pr.height/2 - 2;
    p.style.left = startLeft + 'px';
    p.style.top = startTop + 'px';
    document.body.appendChild(p);

    moveBullet(p, 24);
}

function createDoubleBullets(){
    const pr = player.getBoundingClientRect();
    
    // Upper bullet
    const p1 = document.createElement('div');
    p1.className = 'peluru double';
    p1.style.left = (pr.left + pr.width - 8) + 'px';
    p1.style.top = (pr.top + pr.height/4 - 2) + 'px';
    document.body.appendChild(p1);
    moveBullet(p1, 22);
    
    // Lower bullet
    const p2 = document.createElement('div');
    p2.className = 'peluru double';
    p2.style.left = (pr.left + pr.width - 8) + 'px';
    p2.style.top = (pr.top + 3*pr.height/4 - 2) + 'px';
    document.body.appendChild(p2);
    moveBullet(p2, 22);
}

function createTripleBullets(){
    const pr = player.getBoundingClientRect();
    
    // Upper bullet
    const p1 = document.createElement('div');
    p1.className = 'peluru triple';
    p1.style.left = (pr.left + pr.width - 8) + 'px';
    p1.style.top = (pr.top + pr.height/4 - 2) + 'px';
    document.body.appendChild(p1);
    moveBullet(p1, 20);
    
    // Middle bullet
    const p2 = document.createElement('div');
    p2.className = 'peluru triple';
    p2.style.left = (pr.left + pr.width - 8) + 'px';
    p2.style.top = (pr.top + pr.height/2 - 2) + 'px';
    document.body.appendChild(p2);
    moveBullet(p2, 20);
    
    // Lower bullet
    const p3 = document.createElement('div');
    p3.className = 'peluru triple';
    p3.style.left = (pr.left + pr.width - 8) + 'px';
    p3.style.top = (pr.top + 3*pr.height/4 - 2) + 'px';
    document.body.appendChild(p3);
    moveBullet(p3, 20);
}

function createQuadBullets(){
    const pr = player.getBoundingClientRect();
    
    // Upper bullet
    const p1 = document.createElement('div');
    p1.className = 'peluru quad';
    p1.style.left = (pr.left + pr.width - 8) + 'px';
    p1.style.top = (pr.top + pr.height/5 - 2) + 'px';
    document.body.appendChild(p1);
    moveBullet(p1, 18);
    
    // Upper-middle bullet
    const p2 = document.createElement('div');
    p2.className = 'peluru quad';
    p2.style.left = (pr.left + pr.width - 8) + 'px';
    p2.style.top = (pr.top + 2*pr.height/5 - 2) + 'px';
    document.body.appendChild(p2);
    moveBullet(p2, 18);
    
    // Lower-middle bullet
    const p3 = document.createElement('div');
    p3.className = 'peluru quad';
    p3.style.left = (pr.left + pr.width - 8) + 'px';
    p3.style.top = (pr.top + 3*pr.height/5 - 2) + 'px';
    document.body.appendChild(p3);
    moveBullet(p3, 18);
    
    // Lower bullet
    const p4 = document.createElement('div');
    p4.className = 'peluru quad';
    p4.style.left = (pr.left + pr.width - 8) + 'px';
    p4.style.top = (pr.top + 4*pr.height/5 - 2) + 'px';
    document.body.appendChild(p4);
    moveBullet(p4, 18);
}

function moveBullet(p, speedBul){
    const it = setInterval(()=> {
        if (!document.body.contains(p)) { clearInterval(it); return; }
        p.style.left = (p.offsetLeft + speedBul) + 'px';
        
        // collision with meteors - SEMUA METEOR BISA DISERANG
        gameMeteors.slice().forEach(m => {
            if (isCollide(p, m)){
                // damage meteor - dengan bullet upgrade, semua meteor langsung hancur
                if (bulletUpgraded) {
                    // Langsung hancurkan meteor apapun levelnya
                    const mr = m.getBoundingClientRect();
                    spawnExplosion(mr.left + mr.width/2, mr.top + mr.height/2, 26);
                    m.remove();
                    gameMeteors = gameMeteors.filter(met => met !== m);
                    addScore(15 * rebirthMultiplier); // Bonus score untuk meteor level tinggi
                } else {
                    meteorHit(m);
                }
                p.remove();
                clearInterval(it);
            }
        });
        
        // collision with enemies
        gameEnemies.slice().forEach(e => {
            if (isCollide(p, e)){
                // Check if it's a boss
                if (e.className === 'boss' || e.className === 'megaboss') {
                    bossHit(e);
                } else {
                    // destroy regular enemy
                    enemyHit(e);
                }
                p.remove();
                clearInterval(it);
            }
        });
        
        if (p.offsetLeft > window.innerWidth + 50){
            p.remove();
            clearInterval(it);
        }
    }, 18);
}

/* =================== COLLISION detection =================== */
function isCollide(a, b){
    if (!a || !b) return false;
    const r1 = a.getBoundingClientRect();
    const r2 = b.getBoundingClientRect();
    return !(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom);
}

/* =================== METEOR HIT & EXPLOSION Particles =================== */
function meteorHit(meteor){
    // Play break sound
    breakSound.currentTime = 0;
    breakSound.play();
    
    // decrease level or destroy
    let lvl = Number(meteor.dataset.level || 1);
    if (lvl > 1){
        lvl--;
        meteor.dataset.level = lvl;
        meteor.src = `tingkat${lvl}.png`;
        // small flash
        meteor.style.filter='brightness(1.5)';
        setTimeout(()=> meteor.style.filter='', 120);
        return;
    }
    // final destroy
    const mr = meteor.getBoundingClientRect();
    spawnExplosion(mr.left + mr.width/2, mr.top + mr.height/2, 26);
    meteor.remove();
    gameMeteors = gameMeteors.filter(m => m !== meteor);
    // add score
    addScore(10 * rebirthMultiplier);
}

/* =================== ENEMY HIT =================== */
function enemyHit(enemy){
    // Play break sound
    breakSound.currentTime = 0;
    breakSound.play();
    
    const er = enemy.getBoundingClientRect();
    spawnExplosion(er.left + er.width/2, er.top + er.height/2, 30);
    enemy.remove();
    gameEnemies = gameEnemies.filter(e => e !== enemy);
    // add score
    addScore(20 * rebirthMultiplier);
}

/* =================== BOSS HIT =================== */
function bossHit(boss){
    // Play break sound
    breakSound.currentTime = 0;
    breakSound.play();
    
    const damage = 50 + (upgrades.bullet.level * 10);
    bossHP -= damage;
    
    // Spawn explosion at hit location
    const br = boss.getBoundingClientRect();
    spawnExplosion(br.left + br.width/2, br.top + br.height/2, 15);
    
    // Update boss HP bar
    updateBossHPBar();
    
    // Check if boss is defeated
    if (bossHP <= 0) {
        bossDefeated(boss);
    }
}

function bossDefeated(boss){
    // Big explosion
    const br = boss.getBoundingClientRect();
    spawnExplosion(br.left + br.width/2, br.top + br.height/2, 80);
    
    // Remove boss
    boss.remove();
    gameEnemies = gameEnemies.filter(e => e !== boss);
    bossActive = false;
    bossHPBar.style.display = 'none';
    
    // Tambah jumlah boss yang dikalahkan
    bossDefeatedCount++;
    
    // Add score based on boss type
    const bonusScore = bossType === 'boss' ? 500 : 1000;
    addScore(bonusScore * rebirthMultiplier);
    
    // Switch back to normal music
    bossMusic.pause();
    gameplayMusic.currentTime = 0;
    gameplayMusic.play();
    
    // Show victory message
    showToast(`${bossType === 'boss' ? 'BOSS' : 'MEGA BOSS'} DIKALAHKAN! +${bonusScore} Score`);
    
    // Tampilkan info boss berikutnya
    showToast(`Boss berikutnya pada skor ${nextBossScore}`);
}

function updateBossHPBar(){
    const hpPercent = (bossHP / maxBossHP) * 100;
    bossHPFill.style.width = hpPercent + '%';
    bossHPText.textContent = `${bossType === 'boss' ? 'BOSS' : 'MEGA BOSS'} HP: ${bossHP}/${maxBossHP}`;
}

/* explosion particles function */
function spawnExplosion(x, y, count=18){
    if (typeof x === 'string') x = parseFloat(x) || 0;
    if (typeof y === 'string') y = parseFloat(y) || 0;
    for (let i=0;i<count;i++){
        const part = document.createElement('div');
        part.style.position='absolute';
        part.style.left = (x + Math.random()*40 - 20) + 'px';
        part.style.top = (y + Math.random()*40 - 20) + 'px';
        part.style.width = (2 + Math.random()*6) + 'px';
        part.style.height = part.style.width;
        part.style.borderRadius='50%';
        part.style.pointerEvents='none';
        const hue = 20 + Math.random()*40; // orange-yellow
        part.style.background = `linear-gradient(90deg, rgba(255,${120+Math.floor(Math.random()*80)},40,1), rgba(255,220,120,0.8))`;
        part.style.opacity = '1';
        part.style.zIndex = 999;
        document.body.appendChild(part);

        const vx = (Math.random()-0.5) * (3 + Math.random()*10);
        const vy = (Math.random()-0.5) * (3 + Math.random()*10);

        let life = 600 + Math.random()*500;
        const start = Date.now();
        const anim = setInterval(()=>{
            const t = Date.now() - start;
            if (!document.body.contains(part)){ clearInterval(anim); return; }
            part.style.left = (parseFloat(part.style.left) + vx* (t/1000) ) + 'px';
            part.style.top = (parseFloat(part.style.top) + vy* (t/1000) + 0.02*t) + 'px';
            const prog = t / life;
            part.style.opacity = Math.max(0, 1 - prog);
            part.style.transform = `scale(${1-prog})`;
            if (t > life){
                part.remove();
                clearInterval(anim);
            }
        }, 28);
    }
}

/* =================== COLLISION PLAYER - METEOR (DAMAGE) =================== */
function checkCollisions(){
    // check each meteor if touches player
    const pr = player.getBoundingClientRect();
    gameMeteors.slice().forEach(m => {
        if (!document.body.contains(m)) return;
        if (isCollide(player, m)){
            // damage player
            const dmg = 18 + Math.floor(Math.random()*8);
            reduceHP(dmg);
            // spawn explosion at collision center
            const mr = m.getBoundingClientRect();
            const cx = (Math.max(pr.left,mr.left) + Math.min(pr.right,mr.right))/2;
            const cy = (Math.max(pr.top,mr.top) + Math.min(pr.bottom,mr.bottom))/2;
            spawnExplosion(cx, cy, 22);
            // remove meteor
            m.remove();
            gameMeteors = gameMeteors.filter(x => x !== m);
        }
    });
    
    // check each enemy if touches player
    gameEnemies.slice().forEach(e => {
        if (!document.body.contains(e)) return;
        if (isCollide(player, e)){
            // damage player
            const dmg = 25 + Math.floor(Math.random()*10);
            reduceHP(dmg);
            // spawn explosion at collision center
            const er = e.getBoundingClientRect();
            const cx = (Math.max(pr.left,er.left) + Math.min(pr.right,er.right))/2;
            const cy = (Math.max(pr.top,er.top) + Math.min(pr.bottom,er.bottom))/2;
            spawnExplosion(cx, cy, 25);
            // remove enemy
            e.remove();
            gameEnemies = gameEnemies.filter(x => x !== e);
        }
    });
}

/* =================== HP BAR functions =================== */
function reduceHP(amount){
    currentHP -= amount;
    if (currentHP < 0) currentHP = 0;
    updateHPBar();
    if (currentHP <= 0) onPlayerDeath();
}
function updateHPBar(){
    const pct = Math.max(0, currentHP / maxHP * 100);
    hpBar.style.width = pct + '%';
    if (pct < 30) hpBar.style.background = 'linear-gradient(90deg,#ff6b6b,#ff3b3b)';
    else hpBar.style.background = 'linear-gradient(90deg,var(--hp-fill-start),var(--hp-fill-end))';
}
function onPlayerDeath(){
    gameRunning = false;
    stopMeteorSpawner();
    stopEnemySpawner();
    
    // Play game over sound
    gameoverSound.currentTime = 0;
    gameoverSound.play();
    
    // remove game objects
    gameMeteors.forEach(m => m.remove());
    gameMeteors = [];
    gameEnemies.forEach(e => e.remove());
    gameEnemies = [];
    enemyBullets.forEach(b => b.remove());
    enemyBullets = [];
    
    // Hide boss HP bar
    bossHPBar.style.display = 'none';
    bossWarning.style.display = 'none';
    
    // Update high score REAL TIME - FIXED
    if (score > highScore) {
        highScore = score;
        updateHighScore();
        saveAllData(); // Auto save high score baru
    }
    
    // show game over
    finalScoreText.innerText = 'Score: ' + score;
    gameOver.style.display = 'flex';
    
    // Auto save semua data
    saveAllData();
}

/* =================== SCORE & SKIN UNLOCK =================== */
function addScore(n){
    score += n;
    updateScore();
    checkUnlocks();
    
    // Update high score REAL TIME saat bermain
    if (score > highScore) {
        highScore = score;
        updateHighScore();
    }
}
function updateScore(){ scoreBoard.innerText = 'SCORE: ' + score; }
function updateHighScore(){ 
    highScoreBoard.innerText = 'HIGH SCORE: ' + highScore; 
    // Update juga di upgrade panel
    if (document.getElementById('currentHighScore')) {
        document.getElementById('currentHighScore').textContent = highScore;
    }
}

function checkUnlocks(){
    // Check normal skin unlocks
    const normalUnlockThresholds = {
        1: 100, 2: 200, 3: 350, 4: 500, 5: 700,
        6: 900, 7: 1200, 8: 1500, 9: 1800, 10: 2200,
        11: 2600, 12: 3000, 13: 3500, 14: 4000
    };
    
    for (let i = 1; i <= 14; i++) {
        if (!normalSkinUnlocked[i] && score >= normalUnlockThresholds[i]) {
            normalSkinUnlocked[i] = true;
            unlockNormalSkinVisual(i);
            showToast('Normal Skin ' + (i+1) + ' unlocked!');
            // Auto save saat unlock skin
            saveAllData();
        }
    }
    
    // Check fantasy skin unlocks
    const fantasyUnlockThresholds = {
        1: 150, 2: 300, 3: 500, 4: 700, 5: 1000,
        6: 1500, 7: 2000, 8: 2500, 9: 3000, 10: 4000,
        11: 5000, 12: 6000, 13: 7000, 14: 8000
    };
    
    for (let i = 1; i <= 14; i++) {
        if (!fantasySkinUnlocked[i] && score >= fantasyUnlockThresholds[i]) {
            fantasySkinUnlocked[i] = true;
            unlockFantasySkinVisual(i);
            showToast('Fantasy Skin ' + (i+1) + ' unlocked!');
            // Auto save saat unlock skin
            saveAllData();
        }
    }
}

function unlockNormalSkinVisual(idx){
    const el = document.getElementById('normal' + idx);
    const lbl = document.getElementById('normal' + idx + 'Label');
    if (el) el.classList.remove('locked');
    if (lbl) { 
        lbl.style.color='#fff'; 
        const unlockThresholds = {
            1: 100, 2: 200, 3: 350, 4: 500, 5: 700,
            6: 900, 7: 1200, 8: 1500, 9: 1800, 10: 2200,
            11: 2600, 12: 3000, 13: 3500, 14: 4000
        };
        lbl.innerText = 'Unlocked (' + unlockThresholds[idx] + ')'; 
    }
}

function unlockFantasySkinVisual(idx){
    const el = document.getElementById('skin' + idx);
    const lbl = document.getElementById('skin' + idx + 'Label');
    if (el) el.classList.remove('locked');
    if (lbl) { 
        lbl.style.color='#fff'; 
        const unlockThresholds = {
            1: 150, 2: 300, 3: 500, 4: 700, 5: 1000,
            6: 1500, 7: 2000, 8: 2500, 9: 3000, 10: 4000,
            11: 5000, 12: 6000, 13: 7000, 14: 8000
        };
        lbl.innerText = 'Unlocked (' + unlockThresholds[idx] + ')'; 
    }
}

/* =================== UPGRADE SYSTEM - BISA BERKALI-KALI =================== */
function openUpgradeMenu(){
    clickSound.currentTime = 0;
    clickSound.play();
    
    // Update upgrade costs and buttons
    updateUpgradeButtons();
    upgradePanel.style.display='flex';
}

function closeUpgradeMenu(){
    clickSound.currentTime = 0;
    clickSound.play();
    upgradePanel.style.display='none';
}

function calculateUpgradeCost(baseCost, currentLevel) {
    // Harga naik secara progresif: baseCost * (currentLevel + 1)^1.5
    return Math.floor(baseCost * Math.pow(currentLevel + 1, 1.2));
}

function updateUpgradeButtons(){
    // Update current high score display
    document.getElementById('currentHighScore').textContent = highScore;
    
    // Health upgrade - FIXED PRICE CALCULATION
    const healthCost = calculateUpgradeCost(upgrades.health.baseCost, upgrades.health.level);
    document.getElementById('healthCost').textContent = `Cost: ${healthCost}`;
    document.getElementById('healthLevel').textContent = upgrades.health.level;
    document.getElementById('healthUpgradeBtn').disabled = 
        upgrades.health.level >= upgrades.health.maxLevel || highScore < healthCost;
    
    // Bullet upgrade - FIXED PRICE CALCULATION
    const bulletCost = calculateUpgradeCost(upgrades.bullet.baseCost, upgrades.bullet.level);
    document.getElementById('bulletCost').textContent = `Cost: ${bulletCost}`;
    document.getElementById('bulletLevel').textContent = upgrades.bullet.level;
    document.getElementById('bulletUpgradeBtn').disabled = 
        upgrades.bullet.level >= upgrades.bullet.maxLevel || highScore < bulletCost;
    
    // Speed upgrade - FIXED PRICE CALCULATION
    const speedCost = calculateUpgradeCost(upgrades.speed.baseCost, upgrades.speed.level);
    document.getElementById('speedCost').textContent = `Cost: ${speedCost}`;
    document.getElementById('speedLevel').textContent = upgrades.speed.level;
    document.getElementById('speedUpgradeBtn').disabled = 
        upgrades.speed.level >= upgrades.speed.maxLevel || highScore < speedCost;
    
    // Double shot upgrade
    const doubleCost = calculateUpgradeCost(upgrades.double.baseCost, upgrades.double.level);
    document.getElementById('doubleCost').textContent = `Cost: ${doubleCost}`;
    document.getElementById('doubleLevel').textContent = upgrades.double.level;
    document.getElementById('doubleUpgradeBtn').disabled = 
        upgrades.double.level >= upgrades.double.maxLevel || highScore < doubleCost;
    
    // Triple shot upgrade
    const tripleCost = calculateUpgradeCost(upgrades.triple.baseCost, upgrades.triple.level);
    document.getElementById('tripleCost').textContent = `Cost: ${tripleCost}`;
    document.getElementById('tripleLevel').textContent = upgrades.triple.level;
    document.getElementById('tripleUpgradeBtn').disabled = 
        upgrades.triple.level >= upgrades.triple.maxLevel || highScore < tripleCost;
    
    // Quad shot upgrade
    const quadCost = calculateUpgradeCost(upgrades.quad.baseCost, upgrades.quad.level);
    document.getElementById('quadCost').textContent = `Cost: ${quadCost}`;
    document.getElementById('quadLevel').textContent = upgrades.quad.level;
    document.getElementById('quadUpgradeBtn').disabled = 
        upgrades.quad.level >= upgrades.quad.maxLevel || highScore < quadCost;
    
    // Rebirth upgrade
    const rebirthCost = calculateUpgradeCost(upgrades.rebirth.baseCost, upgrades.rebirth.level);
    document.getElementById('rebirthCost').textContent = `Cost: ${rebirthCost}`;
    document.getElementById('rebirthLevel').textContent = upgrades.rebirth.level;
    document.getElementById('rebirthUpgradeBtn').disabled = 
        upgrades.rebirth.level >= upgrades.rebirth.maxLevel || highScore < rebirthCost;
}

function upgradeHealth(){
    const cost = calculateUpgradeCost(upgrades.health.baseCost, upgrades.health.level);
    if (highScore >= cost && upgrades.health.level < upgrades.health.maxLevel) {
        highScore -= cost;
        upgrades.health.level++;
        maxHP += 50;
        currentHP = maxHP;
        updateHPBar();
        updateHighScore(); // Auto save high score
        updateUpgradeButtons();
        document.getElementById('upgradeStatus').textContent = 'Health upgraded! +50 HP (Total: ' + maxHP + ' HP)';
        showToast('Health upgraded to ' + maxHP + ' HP');
        saveAllData(); // Auto save upgrades
    }
}

function upgradeBullet(){
    const cost = calculateUpgradeCost(upgrades.bullet.baseCost, upgrades.bullet.level);
    if (highScore >= cost && upgrades.bullet.level < upgrades.bullet.maxLevel) {
        highScore -= cost;
        upgrades.bullet.level++;
        bulletUpgraded = true;
        updateHighScore(); // Auto save high score
        updateUpgradeButtons();
        document.getElementById('upgradeStatus').textContent = 'Bullet upgraded! Power increased (Level ' + upgrades.bullet.level + ')';
        showToast('Bullet power upgraded! Level ' + upgrades.bullet.level);
        saveAllData(); // Auto save upgrades
    }
}

function upgradeSpeed(){
    const cost = calculateUpgradeCost(upgrades.speed.baseCost, upgrades.speed.level);
    if (highScore >= cost && upgrades.speed.level < upgrades.speed.maxLevel) {
        highScore -= cost;
        upgrades.speed.level++;
        speed += 1;
        updateHighScore(); // Auto save high score
        updateUpgradeButtons();
        document.getElementById('upgradeStatus').textContent = 'Speed upgraded! +1 movement (Total: ' + speed + ' speed)';
        showToast('Movement speed increased! Level ' + upgrades.speed.level);
        saveAllData(); // Auto save upgrades
    }
}

function upgradeDouble(){
    const cost = calculateUpgradeCost(upgrades.double.baseCost, upgrades.double.level);
    if (highScore >= cost && upgrades.double.level < upgrades.double.maxLevel) {
        highScore -= cost;
        upgrades.double.level++;
        doubleShot = true;
        tripleShot = false;
        quadShot = false;
        updateHighScore(); // Auto save high score
        updateUpgradeButtons();
        document.getElementById('upgradeStatus').textContent = 'Double Shot unlocked!';
        showToast('Double Shot activated!');
        saveAllData(); // Auto save upgrades
    }
}

function upgradeTriple(){
    const cost = calculateUpgradeCost(upgrades.triple.baseCost, upgrades.triple.level);
    if (highScore >= cost && upgrades.triple.level < upgrades.triple.maxLevel) {
        highScore -= cost;
        upgrades.triple.level++;
        doubleShot = false;
        tripleShot = true;
        quadShot = false;
        updateHighScore(); // Auto save high score
        updateUpgradeButtons();
        document.getElementById('upgradeStatus').textContent = 'Triple Shot unlocked!';
        showToast('Triple Shot activated!');
        saveAllData(); // Auto save upgrades
    }
}

function upgradeQuad(){
    const cost = calculateUpgradeCost(upgrades.quad.baseCost, upgrades.quad.level);
    if (highScore >= cost && upgrades.quad.level < upgrades.quad.maxLevel) {
        highScore -= cost;
        upgrades.quad.level++;
        doubleShot = false;
        tripleShot = false;
        quadShot = true;
        updateHighScore(); // Auto save high score
        updateUpgradeButtons();
        document.getElementById('upgradeStatus').textContent = 'Quad Shot unlocked!';
        showToast('Quad Shot activated!');
        saveAllData(); // Auto save upgrades
    }
}

function upgradeRebirth(){
    const cost = calculateUpgradeCost(upgrades.rebirth.baseCost, upgrades.rebirth.level);
    if (highScore >= cost && upgrades.rebirth.level < upgrades.rebirth.maxLevel) {
        highScore -= cost;
        upgrades.rebirth.level++;
        rebirthMultiplier = 1 + (upgrades.rebirth.level * 0.5); // 1.5x, 2x, 2.5x, 3x, 3.5x
        updateHighScore(); // Auto save high score
        updateUpgradeButtons();
        document.getElementById('upgradeStatus').textContent = 'Rebirth activated! Score and damage x' + rebirthMultiplier;
        showToast('Rebirth level ' + upgrades.rebirth.level + '! Multiplier: x' + rebirthMultiplier);
        saveAllData(); // Auto save upgrades
    }
}

/* toast */
let toastT;
function showToast(text){
    clearTimeout(toastT);
    toast.innerText = text;
    toast.style.display = 'block';
    toast.style.opacity = '1';
    toastT = setTimeout(()=> { toast.style.opacity='0'; setTimeout(()=>toast.style.display='none',300); }, 2000);
}

/* =================== SKIN SELECTION =================== */
function openSkinMenu(){ 
    clickSound.currentTime = 0;
    clickSound.play();
    
    // Update normal skins
    for (let i=1;i<=14;i++){
        const el = document.getElementById('normal'+i);
        const lbl = document.getElementById('normal'+i+'Label');
        if (normalSkinUnlocked[i]){ 
            el.classList.remove('locked'); 
            if (lbl) lbl.style.color='#fff'; 
        } else { 
            el.classList.add('locked'); 
            if (lbl) lbl.style.color='#ccc'; 
        }
    }
    
    // Update fantasy skins
    for (let i=1;i<=14;i++){
        const el = document.getElementById('skin'+i);
        const lbl = document.getElementById('skin'+i+'Label');
        if (fantasySkinUnlocked[i]){ 
            el.classList.remove('locked'); 
            if (lbl) lbl.style.color='#fff'; 
        } else { 
            el.classList.add('locked'); 
            if (lbl) lbl.style.color='#ccc'; 
        }
    }
    skinPanel.style.display='flex';
}
function closeSkinMenu(){ 
    clickSound.currentTime = 0;
    clickSound.play();
    skinPanel.style.display='none'; 
}

function trySelectNormalSkin(idx){
    clickSound.currentTime = 0;
    clickSound.play();
    
    if (!normalSkinUnlocked[idx]) {
        const unlockThresholds = {
            1: 100, 2: 200, 3: 350, 4: 500, 5: 700,
            6: 900, 7: 1200, 8: 1500, 9: 1800, 10: 2200,
            11: 2600, 12: 3000, 13: 3500, 14: 4000
        };
        showToast('Skin terkunci. Capai skor ' + unlockThresholds[idx] + ' untuk unlock.');
        return;
    }
    selectedSkin='normal'+(idx+1)+'.png';
    player.src = selectedSkin;
    showToast('Normal Skin ' + (idx+1) + ' diterapkan');
    saveAllData(); // Auto save skin selection
}

function trySelectSkin(idx){
    clickSound.currentTime = 0;
    clickSound.play();
    
    if (!fantasySkinUnlocked[idx]) {
        const unlockThresholds = {
            1: 150, 2: 300, 3: 500, 4: 700, 5: 1000,
            6: 1500, 7: 2000, 8: 2500, 9: 3000, 10: 4000,
            11: 5000, 12: 6000, 13: 7000, 14: 8000
        };
        showToast('Skin terkunci. Capai skor ' + unlockThresholds[idx] + ' untuk unlock.');
        return;
    }
    selectedSkin='skin'+(idx+1)+'.png';
    player.src = selectedSkin;
    showToast('Fantasy Skin ' + (idx+1) + ' diterapkan');
    saveAllData(); // Auto save skin selection
}

/* =================== INFO PANEL =================== */
function openInfoMenu(){
    clickSound.currentTime = 0;
    clickSound.play();
    infoPanel.style.display='flex';
}
function closeInfoMenu(){
    clickSound.currentTime = 0;
    clickSound.play();
    infoPanel.style.display='none';
}

/* =================== SAVE/LOAD SYSTEM - AUTO SAVE =================== */
function saveAllData(){
    localStorage.setItem('meteorGameNormalSkins', JSON.stringify(normalSkinUnlocked));
    localStorage.setItem('meteorGameFantasySkins', JSON.stringify(fantasySkinUnlocked));
    localStorage.setItem('meteorGameUpgrades', JSON.stringify(upgrades));
    localStorage.setItem('meteorGameBulletUpgraded', bulletUpgraded);
    localStorage.setItem('meteorGameSpeed', speed);
    localStorage.setItem('meteorGameMaxHP', maxHP);
    localStorage.setItem('meteorGameSelectedSkin', selectedSkin);
    localStorage.setItem('meteorGameHighScore', highScore);
    localStorage.setItem('meteorGameDoubleShot', doubleShot);
    localStorage.setItem('meteorGameTripleShot', tripleShot);
    localStorage.setItem('meteorGameQuadShot', quadShot);
    localStorage.setItem('meteorGameRebirthMultiplier', rebirthMultiplier);
}

function loadAllData(){
    const savedNormalSkins = localStorage.getItem('meteorGameNormalSkins');
    const savedFantasySkins = localStorage.getItem('meteorGameFantasySkins');
    const savedUpgrades = localStorage.getItem('meteorGameUpgrades');
    const savedBullet = localStorage.getItem('meteorGameBulletUpgraded');
    const savedSpeed = localStorage.getItem('meteorGameSpeed');
    const savedMaxHP = localStorage.getItem('meteorGameMaxHP');
    const savedSkin = localStorage.getItem('meteorGameSelectedSkin');
    const savedHighScore = localStorage.getItem('meteorGameHighScore');
    const savedDouble = localStorage.getItem('meteorGameDoubleShot');
    const savedTriple = localStorage.getItem('meteorGameTripleShot');
    const savedQuad = localStorage.getItem('meteorGameQuadShot');
    const savedRebirth = localStorage.getItem('meteorGameRebirthMultiplier');
    
    if (savedNormalSkins) normalSkinUnlocked = JSON.parse(savedNormalSkins);
    if (savedFantasySkins) fantasySkinUnlocked = JSON.parse(savedFantasySkins);
    if (savedUpgrades) upgrades = JSON.parse(savedUpgrades);
    if (savedBullet) bulletUpgraded = JSON.parse(savedBullet);
    if (savedSpeed) speed = parseInt(savedSpeed);
    if (savedMaxHP) maxHP = parseInt(savedMaxHP);
    if (savedSkin) selectedSkin = savedSkin;
    if (savedHighScore) {
        highScore = parseInt(savedHighScore);
        updateHighScore();
    }
    if (savedDouble) doubleShot = JSON.parse(savedDouble);
    if (savedTriple) tripleShot = JSON.parse(savedTriple);
    if (savedQuad) quadShot = JSON.parse(savedQuad);
    if (savedRebirth) rebirthMultiplier = parseFloat(savedRebirth);
}

/* =================== BUTTON HOVER EFFECTS =================== */
function setupButtonHoverEffects() {
    const buttons = document.querySelectorAll('.btn, .upgrade-btn');
    buttons.forEach(btn => {
        btn.addEventListener('mouseenter', () => {
            clickSound.currentTime = 0;
            clickSound.play();
        });
        
        // Juga play sound saat klik
        btn.addEventListener('click', () => {
            clickSound.currentTime = 0;
            clickSound.play();
        });
    });
}

/* =================== initial state =================== */
(function init(){
    // Load semua data
    loadAllData();
    
    // Setup button hover effects
    setupButtonHoverEffects();
    
    // Set audio volumes dan langsung mainkan soundtrack - FIXED AUTOPLAY
    bgMusic.volume = 0.7;
    gameplayMusic.volume = 0.7;
    shootSound.volume = 0.5;
    breakSound.volume = 0.6;
    clickSound.volume = 0.3;
    gameoverSound.volume = 0.7;
    launchSound.volume = 0.5;
    bossMusic.volume = 0.7;
    if (bossWarningSound) bossWarningSound.volume = 0.8;
    
    // Langsung mainkan soundtrack menu - FIXED AUTOPLAY ISSUE
    setTimeout(() => {
        bgMusic.play().catch(e => {
            console.log('Autoplay prevented, waiting for user interaction');
        });
    }, 100);
    
    // Start menu meteors
    startMenuMeteorSpawner();
    
    // place player center-left (off-screen until start)
    player.style.left = '-320px';
    player.style.top = '50%';
    // Set selected skin
    player.src = selectedSkin;
    // hp full
    currentHP = maxHP;
    updateHPBar();

    // bind skin images alt click prevention
    for (let i = 0; i <= 14; i++) {
        const normalEl = document.getElementById('normal' + i);
        if (normalEl) {
            normalEl.addEventListener('dragstart', e => e.preventDefault());
        }
        
        const fantasyEl = document.getElementById('skin' + i);
        if (fantasyEl) {
            fantasyEl.addEventListener('dragstart', e => e.preventDefault());
        }
    }

    // for mobile: touch to shoot (optional)
    document.addEventListener('touchstart', (e) => {
        if (!gameRunning) return;
        shoot();
    });
    
    // Enable audio setelah interaksi user pertama
    document.addEventListener('click', function enableAudio() {
        bgMusic.play();
        document.removeEventListener('click', enableAudio);
    });
})();

</script>
</body>
</html>
